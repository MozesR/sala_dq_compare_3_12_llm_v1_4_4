async function j(url){const r=await fetch(url,{cache:'no-store'});if(!r.ok)throw new Error('HTTP '+r.status);return await r.json();}
function num(x){const v=Number(x);return Number.isFinite(v)?v:0;}
function safe(val,d=0){return (val===null||val===undefined)?d:val;}
async function loadRuns(){const names=await j('/api/reports?t='+Date.now());const A=document.getElementById('runA');const B=document.getElementById('runB');A.innerHTML='';B.innerHTML='';if(!Array.isArray(names)||!names.length){const opt=document.createElement('option');opt.textContent='No runs yet';A.appendChild(opt.cloneNode(true));B.appendChild(opt);return;}names.forEach(n=>{const o1=document.createElement('option');o1.value=n;o1.textContent=n;A.appendChild(o1);const o2=document.createElement('option');o2.value=n;o2.textContent=n;B.appendChild(o2);});if(names.length>=2){A.selectedIndex=names.length-2;B.selectedIndex=names.length-1;}}
let auditChart,driftChart,outlierChart;function axis(){return{ticks:{color:'#e9f0f8',precision:0},grid:{color:'rgba(255,255,255,0.08)'},beginAtZero:true};}
async function compare(){const A=document.getElementById('runA').value;const B=document.getElementById('runB').value;const st=document.getElementById('status');st.textContent='';if(!A||!B||A==='No runs yet'||B==='No runs yet'){st.textContent='Pick two runs to compare.';return;}try{const d=await j('/api/compare/'+encodeURIComponent(A)+'/'+encodeURIComponent(B)+'?t='+Date.now());render(d);}catch(e){st.textContent='Error: '+e.message;}}
function render(d){const a=d.runA||{},b=d.runB||{};const labels=['assign','impute','compute'];const aD=[num(a.auditTotals?.assign),num(a.auditTotals?.impute),num(a.auditTotals?.compute)];const bD=[num(b.auditTotals?.assign),num(b.auditTotals?.impute),num(b.auditTotals?.compute)];if(auditChart)auditChart.destroy();auditChart=new Chart(document.getElementById('auditChart').getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'Run A',data:aD,backgroundColor:'rgba(99,149,255,0.7)'},{label:'Run B',data:bD,backgroundColor:'rgba(232,99,132,0.7)'}]},options:{responsive:true,plugins:{legend:{labels:{color:'#e9f0f8'}}},scales:{x:axis(),y:axis()}}});const driftLabels=['status_psi','meanΔ(total_amount)'];const aDrift=[num(a.drift?.status_psi),num(a.drift?.total_amount_mean_delta)];const bDrift=[num(b.drift?.status_psi),num(b.drift?.total_amount_mean_delta)];if(driftChart)driftChart.destroy();driftChart=new Chart(document.getElementById('driftChart').getContext('2d'),{type:'bar',data:{labels:driftLabels,datasets:[{label:'Run A',data:aDrift,backgroundColor:'rgba(99,149,255,0.7)'},{label:'Run B',data:bDrift,backgroundColor:'rgba(232,99,132,0.7)'}]},options:{responsive:true,plugins:{legend:{labels:{color:'#e9f0f8'}}},scales:{x:axis(),y:axis()}}});if(outlierChart)outlierChart.destroy();outlierChart=new Chart(document.getElementById('outlierChart').getContext('2d'),{type:'bar',data:{labels:['outliers(total_amount)'],datasets:[{label:'Run A',data:[num(a.outliers)],backgroundColor:'rgba(99,149,255,0.7)'},{label:'Run B',data:[num(b.outliers)],backgroundColor:'rgba(232,99,132,0.7)'}]},options:{responsive:true,plugins:{legend:{labels:{color:'#e9f0f8'}}},scales:{x:axis(),y:axis()}}});const rows=[['assign total',safe(a.auditTotals?.assign),safe(b.auditTotals?.assign),num(b.auditTotals?.assign)-num(a.auditTotals?.assign)],['impute total',safe(a.auditTotals?.impute),safe(b.auditTotals?.impute),num(b.auditTotals?.impute)-num(a.auditTotals?.impute)],['compute total',safe(a.auditTotals?.compute),safe(b.auditTotals?.compute),num(b.auditTotals?.compute)-num(a.auditTotals?.compute)],['status_psi',safe(a.drift?.status_psi),safe(b.drift?.status_psi),num(b.drift?.status_psi)-num(a.drift?.status_psi)],['meanΔ(total_amount)',safe(a.drift?.total_amount_mean_delta),safe(b.drift?.total_amount_mean_delta),num(b.drift?.total_amount_mean_delta)-num(a.drift?.total_amount_mean_delta)],['outliers(total_amount)',safe(a.outliers),safe(b.outliers),num(b.outliers)-num(a.outliers)]];const tb=document.querySelector('#details tbody');tb.innerHTML='';rows.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>`;tb.appendChild(tr);});}
document.getElementById('compareBtn').addEventListener('click', compare);document.addEventListener('DOMContentLoaded',()=>{loadRuns();});
